name: Build Wii boot.dol

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y curl ca-certificates lsb-release xz-utils

    - name: Add devkitPro apt GPG key and repo
      run: |
        sudo mkdir -p /usr/local/share/keyrings
        curl -fsSL https://apt.devkitpro.org/devkitpro-pub.gpg | sudo tee /usr/local/share/keyrings/devkitpro-pub.gpg > /dev/null
        echo "deb [signed-by=/usr/local/share/keyrings/devkitpro-pub.gpg] https://apt.devkitpro.org stable main" | sudo tee /etc/apt/sources.list.d/devkitpro.list
        sudo apt-get update

    - name: Install devkitpro-pacman
      run: |
        sudo apt-get install -y devkitpro-pacman

    - name: Install devkitPPC, libogc and wiiuse (static)
      run: |
        sudo dkp-pacman -Syu --noconfirm
        sudo dkp-pacman -S --noconfirm devkitPPC libogc libogc-static wiiuse wiiuse-static

    - name: Show installed lib files (debug)
      run: |
        echo "Looking for libogc / libpad / wiiuse archives"
        ls -la /opt/devkitpro/libogc || true
        ls -la /opt/devkitpro/libogc/lib || true
        ls -la /opt/devkitpro/libogc/lib/wii || true
        find /opt/devkitpro -maxdepth 4 -name 'libogc*.a' -o -name 'libpad*.a' -o -name 'libwiiuse*.a' -print || true

    - name: Set environment for build
      run: |
        echo "DEVKITPRO=/opt/devkitpro" >> $GITHUB_ENV
        echo "/opt/devkitpro/devkitPPC/bin" >> $GITHUB_PATH
        echo "/opt/devkitpro/tools/bin" >> $GITHUB_PATH

    - name: Debug repo files
      run: |
        pwd
        ls -la
        find . -maxdepth 3 -type f -print

    - name: Build (make)
      run: |
        # Falls Makefile/main.c in Subfolder: cd path/to/subfolder
        make
      working-directory: .
