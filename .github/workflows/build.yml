name: Build Wii boot.dol

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install prerequisites and add devkitPro apt repo
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gnupg ca-certificates lsb-release xz-utils
        # Add devkitPro apt key and repo
        wget -qO- https://apt.devkitpro.org/devkitpro.gpg | sudo apt-key add -
        echo "deb https://apt.devkitpro.org/ubuntu $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/devkitpro.list
        sudo apt-get update
        # Install the devkitpro package manager
        sudo apt-get install -y devkitpro-pacman

    - name: Install devkitPPC and libogc with dkp-pacman
      run: |
        # Update devkitpro package DB and install toolchain + libogc
        sudo dkp-pacman -Syu --noconfirm
        sudo dkp-pacman -S --noconfirm devkitPPC libogc

    - name: Show installed toolchain (debug)
      run: |
        echo "DEVKITPRO location: /opt/devkitpro"
        ls -la /opt/devkitpro || true
        ls -la /opt/devkitpro/devkitPPC/bin || true
        which powerpc-eabi-gcc || true

    - name: Build (make)
      env:
        DEVKITPRO: /opt/devkitpro
      run: |
        # Ensure toolchain/tools are in PATH
        export PATH="$DEVKITPRO/devkitPPC/bin:$DEVKITPRO/tools/bin:$PATH"
        echo "PATH=$PATH"
        make
      working-directory: .   # passe an, falls dein Makefile in Unterordner liegt
