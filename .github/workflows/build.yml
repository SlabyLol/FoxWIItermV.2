name: Build Wii boot.dol

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y wget ca-certificates lsb-release xz-utils gnupg

    - name: Add devkitPro apt repo (securely)
      run: |
        # Save devkitPro GPG key to keyring (apt-key is deprecated)
        sudo mkdir -p /usr/share/keyrings
        sudo curl -fsSL https://apt.devkitpro.org/devkitpro.gpg -o /usr/share/keyrings/devkitpro-archive-keyring.gpg
        # Register repository using signed-by
        echo "deb [signed-by=/usr/share/keyrings/devkitpro-archive-keyring.gpg] https://apt.devkitpro.org/ubuntu $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/devkitpro.list
        sudo apt-get update

    - name: Install devkitpro-pacman
      run: |
        sudo apt-get install -y devkitpro-pacman

    - name: Install devkitPPC and libogc with dkp-pacman
      run: |
        sudo dkp-pacman -Syu --noconfirm
        sudo dkp-pacman -S --noconfirm devkitPPC libogc

    - name: Show toolchain debug info
      run: |
        echo "DEVKITPRO location: /opt/devkitpro"
        ls -la /opt/devkitpro || true
        ls -la /opt/devkitpro/devkitPPC/bin || true
        /opt/devkitpro/devkitPPC/bin/powerpc-eabi-gcc --version || true

    - name: Build (make)
      env:
        DEVKITPRO: /opt/devkitpro
      run: |
        export DEVKITPRO=/opt/devkitpro
        export PATH="$DEVKITPRO/devkitPPC/bin:$DEVKITPRO/tools/bin:$PATH"
        echo "PATH=$PATH"
        pwd
        ls -la
        # falls Makefile/main.c in Unterordner sind, passe hier an (z.B. cd src)
        make
      working-directory: .
