name: Build Wii boot.dol

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y curl ca-certificates lsb-release xz-utils gnupg

    - name: Add devkitPro apt GPG key (recommended location)
      run: |
        sudo mkdir -p /usr/local/share/keyrings
        sudo curl -fsSL https://apt.devkitpro.org/devkitpro-pub.gpg -o /usr/local/share/keyrings/devkitpro-pub.gpg
        ls -la /usr/local/share/keyrings/devkitpro-pub.gpg

    - name: Add devkitPro apt repository (signed-by)
      run: |
        echo "deb [signed-by=/usr/local/share/keyrings/devkitpro-pub.gpg] https://apt.devkitpro.org stable main" | sudo tee /etc/apt/sources.list.d/devkitpro.list
        sudo apt-get update

    - name: Install devkitpro-pacman
      run: |
        sudo apt-get install -y devkitpro-pacman

    - name: Install devkitPPC and libogc with dkp-pacman
      run: |
        sudo dkp-pacman -Syu --noconfirm
        sudo dkp-pacman -S --noconfirm devkitPPC libogc

    - name: Show toolchain debug info
      run: |
        echo "DEVKITPRO location (expected): /opt/devkitpro"
        ls -la /opt/devkitpro || true
        ls -la /opt/devkitpro/devkitPPC/bin || true
        /opt/devkitpro/devkitPPC/bin/powerpc-eabi-gcc --version || true

    - name: Set environment for build
      run: |
        echo "DEVKITPRO=/opt/devkitpro" >> $GITHUB_ENV
        echo "/opt/devkitpro/devkitPPC/bin" >> $GITHUB_PATH
        echo "/opt/devkitpro/tools/bin" >> $GITHUB_PATH

    - name: Debug files (optional)
      run: |
        pwd
        ls -la
        find . -maxdepth 3 -type f -print

    - name: Build (make)
      run: |
        # If your Makefile and sources are in a subfolder, change directory here, e.g.:
        # cd path/to/project
        make
      # working-directory: ./path/to/project # <-- alternativ hier anpassen
